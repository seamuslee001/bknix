#!/usr/bin/env bash

## For systems which use `bin/install-ci.sh` to setup multiple services, this
## helper script allows you to configure your shell to use one of those services.
##
## Examples:
##   eval $(use-bknix min)
##   eval $(use-bknix max)
##   eval $(use-bknix dfl)

if [ -z "$OWNER" ]; then
  OWNER=$USER
fi

PROFILE="$1"

for BASEDIR in "/nix/var/nix/profiles/per-user/$OWNER" "/nix/var/nix/profiles" ;do
  PRFDIR="$BASEDIR/bknix-$PROFILE"
  if [ -d "$PRFDIR" ]; then
    break
  fi
done

if [ -z "$PROFILE" -o ! -d "$PRFDIR" ]; then
  echo "The specified profile does not correspond to an actual profile"
  echo
  echo "usage: $0 <profile>"
  echo "example: $0 dfl"
  exit 1
fi

export PATH="$PRFDIR/bin:$PATH"

## FIXME: The OWNER thing probably shouldn't exist. Easier to just use HOME and USER. But removing it requires other updates/verification.
for CANDIDATE in "/home/$OWNER/bknix" "/home/$OWNER/bknix-$PROFILE" "/Users/$OWNER/bknix" "/Users/$OWNER/bknix-$PROFILE" ; do
  if [ -d "$CANDIDATE" ]; then
    export BKNIXDIR="$CANDIDATE"
  fi
done
if [ ! -d "$BKNIXDIR" ]; then
  echo "WARNING: The BKNIXDIR ($BKNIXDIR) does not exist. If it was initialized by another user, try setting OWNER first." >&2
fi

CODE=`cd "$BKNIXDIR" && loco env --export`
echo "$CODE"
eval "$CODE"
## "bknix env" doesn't add itself to PATH - so we add everything
echo "export PATH='$PRFDIR/bin:$LOCO_PRJ/civicrm-buildkit/bin':\"\$PATH\""
echo "export PS1=\"[\[\e[34m\]bknix-$PROFILE\[\e[m\]:\[\e[32m\]\w\[\e[m\]] \""
