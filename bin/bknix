#!/bin/bash
set -e

## I shouldn't exist! Yet I do! This is a quick hack that doesn't really do
## a nice job of managing processes.
##
## I'd like to see something more like http://supervisord.org/ (which is a non-root process manager)...

if [ -z "$BKNIXDIR" -o ! -d "$BKNIXDIR" ]; then
  echo "Aborting. This command should only run within nix-shell."
  exit 2
fi

###########################################################
## Variables

PROG=$(basename "$0")
DATADIR="$BKNIXDIR/var"
BKIT_BASE="$BKNIXDIR/civicrm-buildkit"
MYSQL_BASE="$BKNIXDIR/var/mysql"
HTTPD_BASE="$BKNIXDIR/var/httpd"
BKIT_PORT=8001

###########################################################
## Library

function bknix_validate() {
  if [ -z "$AMPHOME" ]; then
    echo "Missing expected variable: AMPHOME"
    exit 10
  fi
  if [ -z "$MYSQL_HOME" ]; then
    echo "Missing expected variable: MYSQL_HOME"
    exit 10
  fi
}

function cmd_httpd_init() {
  if [ ! -e "$HTTPD_BASE" ]; then
    echo "($PROG) Initialize httpd config ($HTTPD_BASE)"
    REALHTTPDIR=$(dirname $(dirname $(which httpd)))
    mkdir -p "$HTTPD_BASE" "$HTTPD_BASE/logs" "$HTTPD_BASE/conf" "$HTTPD_BASE/htdocs"
    if [ ! -f "$HTTPD_BASE/htdocs/index.html" ]; then
      echo "<html><body>mynix laceholder</body></html>" > "$HTTPD_BASE/htdocs/index.html"
    fi
    for SUBDIR in bin cgi-bin error icons modules ;do
      [ ! -e "$HTTPD_BASE/$SUBDIR" ] && ln -s "$REALHTTPDIR/$SUBDIR" "$HTTPD_BASE/$SUBDIR"
    done
  fi
  rsync -a "$BKNIXDIR/config/httpd/./" "$HTTPD_BASE/conf/./"
  cat "$BKNIXDIR/config/httpd/httpd.conf.tmpl" | sed "s;%%BKNIXDIR%%;$BKNIXDIR;g" >  "$HTTPD_BASE/conf/httpd.conf"
}

function cmd_mysql_init() {
  if false; then echo; fi
  ## DB init
  #m mkdir -p "$MYSQL_BASE" "$MYSQL_BASE/tmp" "$MYSQL_BASE/conf"
  #m sed "s;%%BKNIXDIR%%;$BKNIXDIR;g" < "$BKNIXDIR/config/my.cnf.tmpl" > "$MYSQL_BASE/conf/my.cnf"
  #m rm -rf "$MYSQL_BASE/data" ## REVERT
  #m if [ ! -d "$MYSQL_BASE/data" ]; then
  #m  echo "($PROG) Initialize MySQL database"
  #m  mysql_install_db
  #m fi
}

function cmd_bkit_init() {
  if [ ! -e "$BKIT_BASE" ]; then
    echo "($PROG) Download buildkit ($BKIT_BASE)"
    git clone https://github.com/civicrm/civicrm-buildkit "$BKIT_BASE"
    civi-download-tools
  fi

  if [ ! -e "$AMPHOME/services.yml" ]; then
    echo "($PROG) Initialize amp config ($AMPHOME)"
    mkdir -p "$AMPHOME"
    amp config:set \
      --httpd_type=apache24 \
      --httpd_restart_command="apachectl -d $HTTPD_BASE -k graceful" \
      --httpd_visibility="local" \
      --httpd_shared_ports="80,$BKIT_PORT" \
      --hosts_type="file" \
      --db_type="mysql_ram_disk" \
      --perm_type=none
  fi

  if [ ! -e "$BKIT_BASE/app/civibuild.conf" ]; then
    echo "($PROG) Initialize civibuild config ($BKIT_BASE/app/civibuild.conf)"
    echo "BLDDIR=\"$BKNIXDIR/build\"" >> "$BKIT_BASE/app/civibuild.conf"
    echo "URL_TEMPLATE=\"http://%SITE_NAME%.bknix:$BKIT_PORT\"" >> "$BKIT_BASE/app/civibuild.conf"
  fi
}

function cmd_mysql_start() {
  echo "($PROG) Start mysqld -- Not implemented: mysqld will auto-start on demand in a ramdisk"
  #mysqld_safe &
}

function cmd_mysql_stop() {
  echo "($PROG) Stop mysqld"
  # [ -f "$MYSQL_BASE/mysql.pid" ] && kill $(cat "$MYSQL_BASE/mysql.pid")
  [ -f "$AMPHOME/ram_disk/mysqld.pid" ] && kill $(cat "$AMPHOME/ram_disk/mysqld.pid" )
}

function cmd_httpd_start() {
  echo "($PROG) Start httpd"
  apachectl -d "$HTTPD_BASE" -k start
}

function cmd_httpd_test() {
  echo "($PROG) Test httpd config"
  apachectl -d "$HTTPD_BASE" -t
}

function cmd_httpd_stop() {
  echo "($PROG) Stop httpd"
  apachectl -d "$HTTPD_BASE" -k stop
}

function cmd_start() {
  cmd_mysql_start
  cmd_httpd_start
}

function cmd_stop() {
  cmd_httpd_stop
  cmd_mysql_stop
}

function cmd_help() {
    echo "usage:"
    echo "  $PROG help            Show help"
    echo "  $PROG init            Initialize config and data files"
    echo "  $PROG start           Start all daemons"
    echo "  $PROG restart         Restart all daemons"
    echo "  $PROG stop            Stop all daemons"
    echo ""
    echo "  $PROG bkit:init       Initialize config and data files"
    echo ""
    #echo "  $PROG mysql:init      Start MySQL daemon"
    #echo "  $PROG mysql:start     Start MySQL daemon"
    #echo "  $PROG mysql:restart   Retart MySQL daemon"
    echo "  $PROG mysql:stop      Stop MySQL daemon"
    echo ""
    echo "  $PROG httpd:init      Test HTTP daemon"
    echo "  $PROG httpd:test      Test HTTP daemon"
    echo "  $PROG httpd:start     Start HTTP daemon"
    echo "  $PROG httpd:restart   Restart HTTP daemon"
    echo "  $PROG httpd:stop      Stop HTTP daemon"
}

###########################################################
## Main

case "$1" in
  httpd:init)    bknix_validate; cmd_httpd_init  ;;
  httpd:restart) bknix_validate; cmd_httpd_init; cmd_httpd_stop; sleep 1; cmd_httpd_start ;;
  httpd:start)   bknix_validate; cmd_httpd_init; cmd_httpd_start ;;
  httpd:stop)    bknix_validate; cmd_httpd_stop ;;
  httpd:test)    bknix_validate; cmd_httpd_init ;cmd_httpd_test ;;

  mysql:init)    bknix_validate; cmd_mysql_init ;;
  mysql:restart) bknix_validate; cmd_mysql_init; cmd_mysql_stop; cmd_mysql_start ;;
  mysql:start)   bknix_validate; cmd_mysql_init; cmd_mysql_start ;;
  mysql:stop)    bknix_validate; cmd_mysql_stop ;;

  bkit:init)     bknix_validate; cmd_bkit_init ;;

  init)          bknix_validate; cmd_httpd_init; cmd_mysql_init; cmd_bkit_init ;;
  restart)       bknix_validate; cmd_httpd_init; cmd_mysql_init; cmd_bkit_init; cmd_stop; cmd_start ;;
  start)         bknix_validate; cmd_httpd_init; cmd_mysql_init; cmd_bkit_init; cmd_start ;;
  stop)          bknix_validate; cmd_stop ;;

  help)          cmd_help ;;
  *)             cmd_help ; exit 1 ;;
esac
